name: Build binaries

on:
  workflow_dispatch
  #schedule:
  #  - cron: '5 5 * * *'

permissions:
  contents: write

env:
  APT: apt -y -qq -o=Dpkg::Use-Pty=0
  S_APT: sudo $APT

  TOR_BUILD_PATH: "/tmp/tor_build"
  
  OPENSSL_DL: "https://github.com/openssl/openssl/releases/download/openssl-3.5.4/openssl-3.5.4.tar.gz"
  OPENSSL_TAR_PATH: "/tmp/openssl.tar.gz"
  OPENSSL_EXTRACT_DIR_PATH: "/tmp/openssl"
  OPENSSL_BUILD_PATH: "$OPENSSL_EXTRACT_DIR_PATH/install"

  ZLIB_DL: "https://zlib.net/current/zlib.tar.gz"
  ZLIB_TAR_PATH: "/tmp/zlib.tar.gz"
  ZLIB_EXTRACT_DIR_PATH: "/tmp/zlib"
  ZLIB_BUILD_PATH: "$ZLIB_EXTRACT_DIR_PATH/install"

  LIBEVENT_DL: "https://github.com/libevent/libevent/releases/download/release-2.1.12-stable/libevent-2.1.12-stable.tar.gz"
  LIBEVENT_TAR_PATH: "/tmp/zlib.tar.gz"
  LIBEVENT_EXTRACT_DIR_PATH: "/tmp/zlib"
  LIBEVENT_BUILD_PATH: "$LIBEVENT_EXTRACT_DIR_PATH/install"
  
  

defaults:
  run:
    shell: bash

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        ARCH: [x86_64, aarch64]
        LIBC: [glibc, musl]
        include:
          - OS: ubuntu-latest
            ARCH: x86_64
          
          - OS: ubuntu-24.04-arm
            ARCH: aarch64

          - CONTAINER: debian:bookworm
            LIBC: glibc

            # remember to build a custom alpine image with bash
          - CONTAINER: frolvlad/alpine-bash:latest
            LIBC: musl
            
    runs-on: ${{ matrix.OS }}
    
    container:
      image: ${{ matrix.CONTAINER }}
    
    env:
      OS: ${{ matrix.OS }}
      ARCH: ${{ matrix.ARCH }}
      CONTAINER: ${{ matrix.CONTAINER }}
      LIBC: ${{ matrix.LIBC }}
  
    steps:
    - name: Install prerequisites
      run: |
        if [[ $CONTAINER =~ "debian" ]]; then
          $APT update && $APT install -y build-essential file sudo bash wget tar
          
          dpkg --get-selections | grep -i libssl
          $APT autoremove --purge libssl-dev
        fi
        
        if [[ $CONTAINER =~ "alpine" ]]; then
          apk -q update && apk add build-base file sudo bash shadow musl wget make tar
          apk del openssl-dev
        fi
        
        sudo chsh root -s /bin/bash

    - name: Create the necessary folders
      run: |
        cd /tmp/
        mkdir -p $OPENSSL_EXTRACT_DIR_PATH

    - name: Download the necessary packages
      run: |
        wget -nv $OPENSSL_DL -O $OPENSSL_TAR_PATH
        wget -nv $ZLIB_DL -O $ZLIB_TAR_PATH
        wget -nv $LIBEVENT_DL -O $LIBEVENT_TAR_PATH
        wget -nv $TOR_DL -O $TOR_TAR_PATH
    
    - name: Compile OpenSSL
      run: |
        cd /tmp/
        tar -xzvf $OPENSSL_TAR_PATH -C $OPENSSL_EXTRACT_DIR_PATH --strip-components=1

        cd $OPENSSL_EXTRACT_DIR_PATH
        ./config --prefix=$OPENSSL_BUILD_PATH no-shared no-dso no-docs > /dev/null
        make -j$(nproc) > /dev/null
        make install

        ls -alh $OPENSSL_BUILD_PATH
